# 가상 면접 사례로 배우는 대규모 시스템 설계 기초(7장)

스터디 날짜: 2025년 7월 23일

# 분산 시스템을 위한 유일 ID 생성기 설계

분산 시스템에서 유일 ID를 사용하려 할 때 단순 Auto Increment 속성으로는 부족하다.

- 서버 한 대라면 유일 ID를 부여할 수 있겠지만, 이는 대규모 트래픽, 고가용성, 확장성을 전부 만족시키지 못한다.
- 각각의 서버에서 Auto Increment 값으로 부여한 유일 ID가 충돌하지 않으려면 각 서버 간의 협의가 있어야 하기 때문에 delay가 생길 수 있다.

## 요구사항

- ID는 유일해야 한다.
- ID는 숫자로만 구성되어야 한다.
- ID는 64비트로 표현될 수 있는 값이어야 한다.
- ID는 발급 날짜에 따라 정렬 가능해야 한다.
- 초당 10,000개의 ID를 만들 수 있어야 한다.

# 분산 시스템에서 유일성이 보장되는 ID를 만드는 방법

- 다중 마스터 복제(multi-master replication)
- UUID(Universally Unique Identifier)
- 티켓 서버(ticket server)
- 트위터 스노플레이크(twitter snowflake) 접근법

## 다중 마스터 복제

- K개의 서버가 있다면 각 서버의 PK를 1씩 증가시키는 것이 아니라 K씩 증가시키며 데이터 중복을 피하는 기법이다.

### 장점

- 단순 AI 값으로도 유일 ID를 부여할 수 있기 때문에 규모 확장성 문제를 어느 정도 해결할 수 있다.

### 단점

- 서버의 수를 변경하는 것에 큰 문제가 생긴다.
- ID는 꾸준히 증가하지만, 각 서버 별로 다르게 커지기 때문에 시간에 따라 정렬할 수 없다.

## UUID

- 128비트짜리 수이다.

### 장점

- 중복되는 값이 나오기 굉장히 어렵기 때문에 서버 간 조율 없이 생성 가능하다.
- 각 서버가 ID 생성기를 가지고 있기 때문에 규모 확장에 있어서 이점이 있다.

### 단점

- 요구사항은 64비트인데, 128비트이기 때문에 요구사항을 벗어난다.
- ID를 시간순으로 정렬할 수 없다.
- 128비트 = 32바이트, 16진수에는 알파벳도 포함되기 때문에 숫자로만 이루어지지 않는다.

### 그렇다면?

- 단순히 완전 유니크한 아이디를 부여하고 싶다면 UUID가 가장 좋은 방법이 될 수 있다.
    - 예를 들어서 노션 페이지의 경우 UUID를 사용하고 있다.
        
        <img width="581" height="58" alt="image" src="https://github.com/user-attachments/assets/00be52f4-165d-4520-81a0-ff17e24780bb" />

        

## 티켓 서버

- Auto Increment를 만들기 위한 DB 서버를 하나 중앙 집중형으로 사용하는 기법이다.

### 장점

- 일반적인 상황에서 모든 요구사항을 만족한다.
- 구현하기 쉽고, 중소 규모 애플리케이션에 적합하다.

### 단점

- 티켓 서버가 SPOF가 된다.
- SPOF를 해결하기 위해서 다중화를 시킨다면 데이터 일관성에 대한 문제가 생긴다.

## 트위터 스노플레이크 접근법

- 원하는 크기의 비트를 원하는 부분(section)으로 나누는 기법이다.
    - 현재의 요구사항에 따르면 64비트를 쪼개어 만들 수 있다.
        
        <img width="1938" height="398" alt="image 1" src="https://github.com/user-attachments/assets/3605fd7c-230d-4ad1-8e48-deb698d8d1a1" />

        
        - 1비트 - 사인 비트, 부호를 구분한다.
        - 41비트 - 타임스탬프, ms 단위로 2^41ms 까지 기록할 수 있다.
        - 5비트 - 데이터센터 수
        - 5비트 - 서버 수
        - 12비트 - 각 서버 별로 관리하는 수로, ID를 하나 생성할 때마다 1씩 증가한다. 이 값은 매 1ms 마다 초기화 된다.

### 장점

- 내가 원하는 구조로 만들 수 있다.
- 각 서버마다 고유한 값을 가지기 때문에 ID 생성기를 서버마다 할당할 수 있다. SPOF의 문제를 피할 수 있다.
- 타임스탬프를 표현하는 비트가 앞에 나오기 때문에 시간 순으로 정렬할 수 있다.

### 단점

- 데이터센터나 서버의 ID를 잘못 변경하게 되면 ID 충돌이 일어날 수 있다.
- 타임스탬프를 기록하는 비트의 수에 따라서 ID 생성기의 수명이 결정된다. 현재의 경우 약 69년이 지나면 새로운 체계를 만들어야 한다.
- section을 나누어 놨기 때문에, 기존에 설정한 값을 넘어서게 되면 overflow 문제가 생길 수 있다.
- 타임스탬프를 사용하는 만큼 각 서버들이 동일한 시간을 바라봐야만 한다.
    - 이 문제를 해결하기 위해 NTP가 보편적으로 사용된다.
