
# 가상 면접 사례로 배우는 대규모 시스템 설계 기초(5장)

스터디 날짜: 2025년 7월 9일

# 해시 키 재배치 문제란?

## 배경

일반적으로 N개의 캐시 서버가 있을 때 부하를 균등하게 나누기 위해서 **해시**를 사용한다.

- `serverIndex = hash(Key) % N` 의 함수를 사용하여 서버 인덱스를 지정한다.

## 단순 해시가 잘 작동하는 상황

- 서버 풀의 크기가 고정일 때  
- 데이터의 분포가 균등할 때

## 단순 해시가 문제가 되는 상황

- 어떤 서버가 장애를 일으켜서 가용한 서버의 수가 줄어들 때

가용한 서버의 수가 달라지게 된다면 **모든 해시 값**은 다시 계산되어야 한다. 이는 대규모 캐시 미스로 이어지게 된다.


# 안정 해시란?

- 테이블의 크기가 조정될 때 **평균적으로 K/N 개의 키만 재배치**하는 해시 기술  
    - K = 키의 수, N = 슬롯의 수

## 해시 공간과 해시 링

어떤 해시 함수 f를 사용한다면 그림 5-3과 같은 해시 공간을 만들 수 있다. 이 해시 공간의 시작점과 끝점을 잇는다면 그림 5-4와 같은 해시 링이 만들어진다.

<img src="https://github.com/user-attachments/assets/89f91106-07bb-47f4-8e63-fc8ccd6f46c3" width="50%" />

<img src="https://github.com/user-attachments/assets/637c8100-264b-4203-8d9d-2507e8f9f9f9" width="50%" />

해시 함수 f에 들어가는 인자에 서버의 IP나 이름을 넣는다면 그 값을 해시 링 위의 어떤 위치에 해시 서버를 대응시킬 수 있게 된다. 또한 캐시할 키를 똑같은 해시 함수 f에 넣는다면 다음과 같은 그림이 나올 수 있다.

<img src="https://github.com/user-attachments/assets/2fbce5b6-86fe-4513-b92e-7299f03a99e0" width="50%" />

위의 상황에서 각 키가 시계 방향으로 링을 탐색해 나가면서 만나는 첫번째 서버가 키가 저장되는 서버이다.

<img src="https://github.com/user-attachments/assets/c5a35f1b-b35e-4a1e-98b3-9c186506509e" width="50%" />

이처럼 시계 방향의 서버에 속하기 때문에 서버가 추가되거나 제거될 때 일부만 재배치하면 된다.

<img src="https://github.com/user-attachments/assets/12c744ed-91c5-4008-afe6-225d692e6731" width="50%" />

<img src="https://github.com/user-attachments/assets/f107d4a0-c9a3-45e8-8240-9b936c44b77b" width="50%" />


## 구현 방법

- 서버와 키를 균등 분포 해시 함수에 넣기  
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버를 선택

## 문제점

- 노드를 추가하거나 제거하면 특정 부분에 키가 몰리거나 희소해지는 상황이 생긴다.  
  즉, 균등하게 파티션의 크기를 유지하는 것이 불가능하다.


## 해결책 → 가상노드 (= 복제 노드)

- 임의의 수의 복제 노드를 임의의 위치에 둔다.  
- 이때 가상 노드의 수를 더 늘리면 키의 분포는 점점 더 균등해진다.
    - 저장 공간과 키 분포의 표준편차 사이의 trade off를 잘 결정해야 한다.

<img src="https://github.com/user-attachments/assets/9be57ac8-7e5a-4b36-abd6-e771ff5f5949" width="50%" />

- 키가 속해있는 서버가 제거된다면, 시계 방향으로 나아가며 가장 먼저 등장하는 서버에 재배치한다.
    - 즉, 지워진 서버(S4)부터 그 이전에 존재하는 서버(S3) 사이에 있는 모든 키들이 재배치 된다.

<img src="https://github.com/user-attachments/assets/ec40faa0-e81e-435c-854f-c55dc539199c" width="50%" />
